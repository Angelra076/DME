name: Check Issue Link
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches: [Dev]

jobs:
  check-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Verify linked work item (Issue)
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const title = context.payload.pull_request.title || '';
            const issuePattern = /#\d+/;
            const closingPattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i;

            const hasRefInTitle = issuePattern.test(title);
            const hasRefInBody = issuePattern.test(body);
            const hasClosingKeyword = closingPattern.test(body);

            if (!hasRefInTitle && !hasRefInBody) {
              core.setFailed(
                'El Pull Request debe referenciar al menos un Work Item/Issue (ej. #123) en el titulo o descripcion.\n' +
                'Ejemplo en descripcion: "Fixes #45" o "Closes #12"'
              );
              return;
            }

            if (hasClosingKeyword) {
              core.info('Work Item vinculado correctamente con keyword de cierre.');
            } else {
              core.warning('Se encontro referencia a Issue pero sin keyword de cierre (Fixes, Closes, Resolves). Se recomienda usar: "Fixes #XX".');
            }
